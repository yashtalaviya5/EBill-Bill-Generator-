@model EBill.Models.BillDetail
@{
    ViewBag.Title = "Create";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-sm-6 col-md-6 col-lg-6 offset-3 shadow rounded" style="background-color:#FAF5EF;">
            @using (Html.BeginForm())
            {
                <div class="mt-2">
                    <h1 class="fw-bold mb-4 text-light text-center" style="background-color: #151B54">Create Bill</h1>
                </div>
                <div class="mb-3">
                    <label class="form-label">Customer Name</label>
                    @Html.TextBoxFor(modelItem => modelItem.CustomerName,
                        new { @class = "form-control form-control-sm", @required = "required" })
                </div>

                <div class="mb-3">
                    <label class="form-label">Mobile Number</label>
                    @Html.TextBoxFor(modelItem => modelItem.MobileNumber, new
                    {
                        @class = "form-control form-control-sm",
                        maxlength = "10",
                        type = "tel",
                        pattern = "[0-9]{10}",
                        title = "Enter 10 digit mobile number"
                    })
                </div>

                <div class="mb-3">
                    <label class="form-label">Address</label>
                    @Html.TextBoxFor(modelItem => modelItem.Address, new { @class = "form-control form-control-sm", @required = "required" })
                </div>
                <div class="mb-3">
                    <div class="mb-2">
                        <span class="h5">Items</span>
                        <button type="button" class="btn btn-sm text-light border float-end" style="background-color:#151b54" data-bs-toggle="modal" data-bs-target="#modalbox">Add</button>
                    </div>

                    <table id="items" class="table table-striped table-responsive table-hover table-bordered">
                        <thead>
                            <tr>
                                <th>Product Name</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

                <div class="mb-3">
                    <button type="submit" class="btn text-light btn-sm" style="background-color:#151b54">Save</button>
                </div>

            }
        </div>
    </div>
</div>
<div class="modal fade" id="modalbox" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background-color:#FAF5EF;">
            <div class="modal-body">
                <label class="form-label">Product Name</label>
                <input type="text" class="form-control form-control-sm" placeholder="Enter Product Name"
                       id="productname" name="productname" required />
                <div class="invalid-feedback">Product name is required.</div>
            </div>

            <div class="modal-body">
                <label class="form-label">Price</label>
                <input type="text" class="form-control form-control-sm" placeholder="Enter Price"
                       id="price" name="price" required
                       pattern="^[0-9]+(\.[0-9]{1,2})?$"
                       title="Enter valid price (only numbers, max 2 decimals)" />
                <div class="invalid-feedback">Enter valid price (e.g., 100 or 29.50).</div>
            </div>

            <div class="modal-body">
                <label class="form-label">Quantity</label>
                <input type="text" class="form-control form-control-sm" placeholder="Enter Quantity"
                       id="quantity" name="quantity" required
                       pattern="^[0-9]+$"
                       title="Enter valid quantity (whole numbers only)" />
                <div class="invalid-feedback">Enter valid quantity (whole numbers only).</div>
            </div>

            <div class="modal-body">
                <button class="btn text-light btn-sm " style="background-color:#151b54" type="button" id="addItem">Add</button>
                <button class="btn text-light btn-sm btn-danger" type="button" data-bs-toggle="modal">Close</button>
            </div>
        </div>
    </div>
</div>
</div>
<script src="~/Scripts/jquery-1.10.2.min.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        $('#addItem').click(function (e) {
            e.preventDefault(); 

            let productName = $('#productname').val().trim();
            let price = $('#price').val().trim();
            let quantity = $('#quantity').val().trim();

            let isValid = true;

            if (productName === "") {
                $('#productname').addClass("is-invalid");
                isValid = false;
            } else {
                $('#productname').removeClass("is-invalid");
            }

            let pricePattern = /^[0-9]+(\.[0-9]{1,2})?$/;
            if (!pricePattern.test(price)) {
                $('#price').addClass("is-invalid");
                isValid = false;
            } else {
                $('#price').removeClass("is-invalid");
            }

            let qtyPattern = /^[0-9]+$/;
            if (!qtyPattern.test(quantity)) {
                $('#quantity').addClass("is-invalid");
                isValid = false;
            } else {
                $('#quantity').removeClass("is-invalid");
            }

            if (!isValid) {
                return;
            }

            let ItemIndex = $('#items tbody tr').length;

            $.ajax({
                url: "/EBill/CreateItem",
                type: "POST",
                data: { productName, price, quantity, ItemIndex },
                success: function (resp) {
                    $('#items tbody').append(resp);

                    $('#productname').val("");
                    $('#price').val("");
                    $('#quantity').val("");

                    $('#myModal').modal('hide');
                },
                error: function (err) {
                    alert(err.responseText);
                }
            });

        });
    });
</script>

